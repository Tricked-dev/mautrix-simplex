name: Build and Push Docker Image

on:
  push:
    branches: [master]
    tags: ["v*"]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check if simplex-chat.nix changed
        id: simplex-changed
        run: |
          if git diff --name-only HEAD^ HEAD | grep -q 'nix/simplex-chat.nix'; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
          fi

      - uses: DeterminateSystems/nix-installer-action@main
      - uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Build bridge Docker images
        run: |
          nix build .#dockerImage -o result-bridge
          nix build .#dockerImageBundled -o result-bundled

      - name: Build simplex-chat Docker image
        if: steps.simplex-changed.outputs.changed == 'true'
        run: nix build .#dockerImageSimplex -o result-simplex

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Push bridge Docker images
        run: |
          REPO="${{ github.repository }}"
          REPO="${REPO,,}"

          docker load < result-bridge
          docker load < result-bundled

          docker tag mautrix-simplex:latest       "ghcr.io/${REPO}:latest"
          docker tag mautrix-simplex:with-simplex "ghcr.io/${REPO}:with-simplex"

          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            TAG="${{ github.ref_name }}"
            docker tag mautrix-simplex:latest       "ghcr.io/${REPO}:${TAG}"
            docker tag mautrix-simplex:with-simplex "ghcr.io/${REPO}:${TAG}-with-simplex"
            docker push "ghcr.io/${REPO}:${TAG}"
            docker push "ghcr.io/${REPO}:${TAG}-with-simplex"
          fi

          docker push "ghcr.io/${REPO}:latest"
          docker push "ghcr.io/${REPO}:with-simplex"

      - name: Push simplex-chat Docker image
        if: steps.simplex-changed.outputs.changed == 'true'
        run: |
          OWNER="${{ github.repository_owner }}"
          OWNER="${OWNER,,}"
          SIMPLEX_VERSION="$(nix eval --raw .#packages.x86_64-linux.simplex-chat.version)"

          docker load < result-simplex

          docker tag simplex-chat:latest "ghcr.io/${OWNER}/simplex-chat:latest"
          docker tag simplex-chat:latest "ghcr.io/${OWNER}/simplex-chat:${SIMPLEX_VERSION}"

          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            TAG="${{ github.ref_name }}"
            docker tag simplex-chat:latest "ghcr.io/${OWNER}/simplex-chat:${TAG}"
            docker push "ghcr.io/${OWNER}/simplex-chat:${TAG}"
          fi

          docker push "ghcr.io/${OWNER}/simplex-chat:latest"
          docker push "ghcr.io/${OWNER}/simplex-chat:${SIMPLEX_VERSION}"
