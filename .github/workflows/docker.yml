name: Build and Push Docker Image

on:
  push:
    branches: [master]
    tags: ["v*"]

jobs:
  build:
    strategy:
      matrix:
        include:
          - runner: ubuntu-latest
            nix-system: x86_64-linux
            platform: amd64
          - runner: ubuntu-24.04-arm
            nix-system: aarch64-linux
            platform: arm64

    runs-on: ${{ matrix.runner }}
    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check if simplex-chat.nix changed
        id: simplex-changed
        run: |
          if git diff --name-only HEAD^ HEAD | grep -q 'nix/simplex-chat.nix'; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
          fi

      - uses: DeterminateSystems/nix-installer-action@main
      - uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Build bridge Docker images
        run: |
          nix build .#dockerImage -o result-bridge
          nix build .#dockerImageBundled -o result-bundled

      - name: Build simplex-chat Docker image
        if: steps.simplex-changed.outputs.changed == 'true'
        run: nix build .#dockerImageSimplex -o result-simplex

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Push bridge Docker images
        run: |
          REPO="${{ github.repository }}"
          REPO="${REPO,,}"
          PLATFORM="${{ matrix.platform }}"

          docker load < result-bridge
          docker load < result-bundled

          docker tag mautrix-simplex:latest       "ghcr.io/${REPO}:latest-${PLATFORM}"
          docker tag mautrix-simplex:with-simplex "ghcr.io/${REPO}:with-simplex-${PLATFORM}"

          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            TAG="${{ github.ref_name }}"
            docker tag mautrix-simplex:latest       "ghcr.io/${REPO}:${TAG}-${PLATFORM}"
            docker tag mautrix-simplex:with-simplex "ghcr.io/${REPO}:${TAG}-with-simplex-${PLATFORM}"
            docker push "ghcr.io/${REPO}:${TAG}-${PLATFORM}"
            docker push "ghcr.io/${REPO}:${TAG}-with-simplex-${PLATFORM}"
          fi

          docker push "ghcr.io/${REPO}:latest-${PLATFORM}"
          docker push "ghcr.io/${REPO}:with-simplex-${PLATFORM}"

      - name: Push simplex-chat Docker image
        if: steps.simplex-changed.outputs.changed == 'true'
        run: |
          OWNER="${{ github.repository_owner }}"
          OWNER="${OWNER,,}"
          PLATFORM="${{ matrix.platform }}"
          SIMPLEX_VERSION="$(nix eval --raw ".#packages.${{ matrix.nix-system }}.simplex-chat.version")"

          docker load < result-simplex

          docker tag simplex-chat:latest "ghcr.io/${OWNER}/simplex-chat:latest-${PLATFORM}"
          docker tag simplex-chat:latest "ghcr.io/${OWNER}/simplex-chat:${SIMPLEX_VERSION}-${PLATFORM}"

          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            TAG="${{ github.ref_name }}"
            docker tag simplex-chat:latest "ghcr.io/${OWNER}/simplex-chat:${TAG}-${PLATFORM}"
            docker push "ghcr.io/${OWNER}/simplex-chat:${TAG}-${PLATFORM}"
          fi

          docker push "ghcr.io/${OWNER}/simplex-chat:latest-${PLATFORM}"
          docker push "ghcr.io/${OWNER}/simplex-chat:${SIMPLEX_VERSION}-${PLATFORM}"

  manifest:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check if simplex-chat.nix changed
        id: simplex-changed
        run: |
          if git diff --name-only HEAD^ HEAD | grep -q 'nix/simplex-chat.nix'; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Create multi-arch manifests for bridge
        run: |
          REPO="${{ github.repository }}"
          REPO="${REPO,,}"

          docker buildx imagetools create --tag "ghcr.io/${REPO}:latest" \
            "ghcr.io/${REPO}:latest-amd64" \
            "ghcr.io/${REPO}:latest-arm64"
          docker buildx imagetools create --tag "ghcr.io/${REPO}:with-simplex" \
            "ghcr.io/${REPO}:with-simplex-amd64" \
            "ghcr.io/${REPO}:with-simplex-arm64"

          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            TAG="${{ github.ref_name }}"
            docker buildx imagetools create --tag "ghcr.io/${REPO}:${TAG}" \
              "ghcr.io/${REPO}:${TAG}-amd64" \
              "ghcr.io/${REPO}:${TAG}-arm64"
            docker buildx imagetools create --tag "ghcr.io/${REPO}:${TAG}-with-simplex" \
              "ghcr.io/${REPO}:${TAG}-with-simplex-amd64" \
              "ghcr.io/${REPO}:${TAG}-with-simplex-arm64"
          fi

      - name: Create multi-arch manifest for simplex-chat
        if: steps.simplex-changed.outputs.changed == 'true'
        run: |
          OWNER="${{ github.repository_owner }}"
          OWNER="${OWNER,,}"

          docker buildx imagetools create --tag "ghcr.io/${OWNER}/simplex-chat:latest" \
            "ghcr.io/${OWNER}/simplex-chat:latest-amd64" \
            "ghcr.io/${OWNER}/simplex-chat:latest-arm64"

          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            TAG="${{ github.ref_name }}"
            docker buildx imagetools create --tag "ghcr.io/${OWNER}/simplex-chat:${TAG}" \
              "ghcr.io/${OWNER}/simplex-chat:${TAG}-amd64" \
              "ghcr.io/${OWNER}/simplex-chat:${TAG}-arm64"
          fi
